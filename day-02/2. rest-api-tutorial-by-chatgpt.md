
# тЪЩя╕П ржкрзНрж░ржХрж▓рзНржк рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ (functional + Laravel-like pattern but simple)

```
mini-php-api/
тФВ
тФЬтФАтФА app/
тФВ   тФФтФАтФА auth.php               <-- login handler (functional)
тФВ
тФЬтФАтФА core/
тФВ   тФЬтФАтФА db.php                 <-- PDO connection function
тФВ   тФФтФАтФА jwt.php                <-- JWT encode / decode functions
тФВ
тФЬтФАтФА config/
тФВ   тФЬтФАтФА database.php           <-- DB config (array)
тФВ   тФФтФАтФА jwt.php                <-- JWT config (secret, expiry)
тФВ
тФЬтФАтФА helpers/
тФВ   тФФтФАтФА http.php               <-- small HTTP helper functions
тФВ
тФЬтФАтФА scripts/
тФВ   тФФтФАтФА create_user.php        <-- CLI script to add initial user (hashed password)
тФВ
тФЬтФАтФА routes/
тФВ   тФФтФАтФА api.php                <-- route dispatcher
тФВ
тФЬтФАтФА index.php                  <-- entry point
тФФтФАтФА README.md
```

---

# 1) `config/database.php`

```php
<?php
// config/database.php
return [
  'host' => '127.0.0.1',
  'dbname' => 'mini_api',
  'username' => 'root',
  'password' => '',
  'charset' => 'utf8mb4'
];
```

**ржПржХржжржо ржнрж╛ржЩрж╛-ржнрж╛ржЩрж╛ ржмрзНржпрж╛ржЦрзНржпрж╛**

* `<?php` тАФ ржкрж┐ржПржЗржЪржкрж┐ рж╕рзНржХрзНрж░рж┐ржкрзНржЯ рж╢рзБрж░рзБред рж╕ржм PHP ржлрж╛ржЗрж▓рзЗ рж▓рж╛ржЧрзЗред
* `return [...]` тАФ ржПржЗ ржлрж╛ржЗрж▓ `include` ржХрж░рж▓рзЗ ржПржЯрж╛ржХрзЗ ржПржХржЯрж┐ array рж╣рж┐рж╕рзЗржмрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛ржмрзЗ; ржЖржорж░рж╛ ржХржиржлрж┐ржЧ рж╣рж┐рж╕рзЗржмрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмред
* `host, dbname, username` ржЗрждрзНржпрж╛ржжрж┐ тАФ ржбрж╛ржЯрж╛ржмрзЗрж╕ рж╕ржВржпрзЛржЧрзЗрж░ ржЬржирзНржп ржкрзНрж░ржпрж╝рзЛржЬржирзАрзЯ рждржерзНржпред ржкрж░рзЗ `core/db.php` ржПржЗ array ржирж┐ржмрзЗред
`charset` ржорж╛ржирзЗ **Character Set**, ржЕрж░рзНржерж╛рзО тАФ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржХрзА ржзрж░ржирзЗрж░ ржЕржХрзНрж╖рж░ (letters, symbols, emoji ржЗрждрзНржпрж╛ржжрж┐) рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рж╛ ржпрж╛ржмрзЗ, рж╕рзЗржЯрж╛ ржмрж▓рзЗ ржжрзЗрзЯред

---

### ЁЯЖЪ рзи. `utf8` vs `utf8mb4`

| ржмрж┐рж╖рзЯ                  | `utf8`                       | `utf8mb4`                  |
| --------------------- | ---------------------------- | -------------------------- |
| ржирж╛ржорзЗрж░ ржорж╛ржирзЗ            | Unicode UTF-8                | UTF-8 Multi-Byte (4 bytes) |
| ржХрзЯржЯрж╛ ржмрж╛ржЗржЯ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ | рж╕рж░рзНржмрзЛржЪрзНржЪ 3 byte              | рж╕рж░рзНржмрзЛржЪрзНржЪ 4 byte            |
| ржХрзА рж╕рж╛ржкрзЛрж░рзНржЯ ржХрж░рзЗ ржирж╛     | ржЗржорзЛржЬрж┐ ЁЯШД, ржХрж┐ржЫрзБ ржмрж┐рж╢рзЗрж╖ ржЗржЙржирж┐ржХрзЛржб | рж╕ржм ржЗржЙржирж┐ржХрзЛржб, ржЗржорзЛржЬрж┐ рж╕рж╣       |
| ржЖржзрзБржирж┐ржХ рж╕рзНржЯрзНржпрж╛ржирзНржбрж╛рж░рзНржб  | тЭМ ржкрзБрж░рзЛржирзЛ                     | тЬЕ ржирждрзБржи ржУ ржкрзВрж░рзНржгрж╛ржЩрзНржЧ         |

---

### ЁЯзй рзй. ржХрзЗржи `'utf8mb4'` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ ржЙржЪрж┐ржд?

ржХрж╛рж░ржг:

1. ржПржЯрж╛ **рж╕ржм Unicode ржХрзНржпрж╛рж░рзЗржХрзНржЯрж╛рж░** рж╕рж╛ржкрзЛрж░рзНржЯ ржХрж░рзЗ (emoji, ржЪрзАржирж╛ ржнрж╛рж╖рж╛, ржЖрж░ржмрж┐, ржмрж╛ржВрж▓рж╛ рж╕ржм ржХрж┐ржЫрзБ)ред
2. Facebook, Twitter-ржПрж░ ржорждрзЛ ржмрзЬ ржкрзНрж▓рзНржпрж╛ржЯржлрж░рзНржоржЧрзБрж▓рзЛржУ `utf8mb4` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗред
3. ржкрзБрж░ржирзЛ `utf8` ржЖрж╕рж▓рзЗ **ржЖрж╕рж▓рзЗ ржкрзБрж░рзЛ UTF-8 ржирж╛**, рж╢рзБржзрзБ 3-byte ржкрж░рзНржпржирзНржд рж╕рж╛ржкрзЛрж░рзНржЯ ржХрж░рзЗ тАФ рждрж╛ржЗ ржХрж┐ржЫрзБ ржЯрзЗржХрзНрж╕ржЯ ржмрж┐ржХрзГржд рж╣рждрзЗ ржкрж╛рж░рзЗред

---

### ЁЯз╛ рзк. Laravel ржмрж╛ PHP config-ржП ржПржЯрж╛ ржжрзЗржЦрж╛ ржпрж╛рзЯ

```php
'mysql' => [
    'driver' => 'mysql',
    'host' => env('DB_HOST', '127.0.0.1'),
    'charset' => 'utf8mb4',
    'collation' => 'utf8mb4_unicode_ci',
],
```

ЁЯСЙ ржПржЦрж╛ржирзЗ `charset` ржмрж▓рзЗ ржжрж┐ржЪрзНржЫрзЗ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржХрзАржнрж╛ржмрзЗ ржЯрзЗржХрзНрж╕ржЯ рж╕ржВрж░ржХрзНрж╖ржг рж╣ржмрзЗ,
ржЖрж░ `collation` ржмрж▓рзЗ ржжрж┐ржЪрзНржЫрзЗ тАФ **ржХрзАржнрж╛ржмрзЗ рж╕рж╛ржЬрж╛ржирзЛ (sorting)** ржУ **рждрзБрж▓ржирж╛ (comparison)** рж╣ржмрзЗред

---

### ЁЯза рж╕ржВржХрзНрж╖рзЗржкрзЗ:

> `'charset' => 'utf8mb4'` ржорж╛ржирзЗ рж╣рж▓рзЛ тАФ
> тАЬржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржПржоржи ржЗржЙржирж┐ржХрзЛржб ржПржиржХрзЛржбрж┐ржВ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ, ржпрж╛рждрзЗ рж╕ржм ржнрж╛рж╖рж╛ ржУ ржЗржорзЛржЬрж┐ ржарж┐ржХржнрж╛ржмрзЗ рж╕рж╛ржкрзЛрж░рзНржЯ ржкрж╛рзЯредтАЭ



---

# 2) `config/jwt.php`

```php
<?php
// config/jwt.php
return [
  'secret' => 'change_this_to_a_strong_random_string_!@#', // production ржП .env ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ
  'algo' => 'HS256',
  'expiry' => 3600 // token life in seconds (1 hour)
];
```

**ржмрзНржпрж╛ржЦрзНржпрж╛**

* `secret` тАФ JWT рж╕рж┐ржЧржирзЗржЪрж╛рж░рзЗрж░ ржЬржирзНржп ржХрзАред ржЕржмрж╢рзНржпржЗ рж╢ржХрзНрждрж┐рж╢рж╛рж▓рзА рж░рж╛ржЦржмрзЗ; production ржП env ржерзЗржХрзЗ ржирзЗржмрзЗред
* `expiry` тАФ ржЯрзЛржХрзЗржи ржХрждржХрзНрж╖ржг ржмрзИржз ржерж╛ржХржмрзЗ (seconds)ред

---

# 3) `core/db.php` тАФ PDO рж╕ржВржпрзЛржЧ (functional)

```php
<?php
// core/db.php
function db_connect() {
  $cfg = include __DIR__ . '/../config/database.php';

  // DSN (Data Source Name) рждрзИрж░рж┐
  $dsn = "mysql:host={$cfg['host']};dbname={$cfg['dbname']};charset={$cfg['charset']}";

  $options = [
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,        // error рж╣рж▓рзЗ Exception ржЫрзБржБржбрж╝ржмрзЗ
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,   // fetch ржХрж░рж▓рзЗ associative array ржкрж╛ржм
    PDO::ATTR_EMULATE_PREPARES => false                 // ржирзЗржЯрж┐ржн prepared statements ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗ
  ];

  try {
    return new PDO($dsn, $cfg['username'], $cfg['password'], $options);
  } catch (PDOException $e) {
    // production ржП ржПржЦрж╛ржирзЗ generic message рж░рж╛ржЦрзЛ, local/development ржП $e->getMessage() ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░рзЛ
    http_response_code(500);
    echo json_encode(['error' => 'Database connection failed']);
    exit;
  }
}
```

**рж▓рж╛ржЗржи-ржмрж╛ржЗ-рж▓рж╛ржЗржи ржмрзНржпрж╛ржЦрзНржпрж╛ (Atomic):**

1. `function db_connect()` тАФ ржЖржорж░рж╛ ржПржХржЯрж╛ function ржмрж╛ржирж╛ржЪрзНржЫрж┐; ржПржЯрж╛ ржХрж▓ ржХрж░рж▓рзЗ PDO ржЕржмржЬрзЗржХрзНржЯ рж░рж┐ржЯрж╛рж░рзНржи ржХрж░ржмрзЗред (ржлрж╛ржВрж╢ржирж╛рж▓ рж╕рзНржЯрж╛ржЗрж▓)
2. `$cfg = include ...` тАФ ржХржиржлрж┐ржЧ ржлрж╛ржЗрж▓ рж▓рзЛржб ржХрж░рзЗ $cfg ржП рж░рж╛ржЦрж▓рж╛ржо (array)ред
3. `$dsn = "mysql:host=...";` тАФ PDO ржХрзАржнрж╛ржмрзЗ DB-рждрзЗ ржЧрзЗрж▓ рждрж╛ ржмрж▓рзЗ ржжрзЗрзЯ (host, dbname, charset)ред
4. `$options = [...]` тАФ PDO ржХрж╛ржЬ ржХрж░рж╛рж░ рж╕ржорзЯ ржирж┐рж░рж╛ржкрждрзНрждрж╛ ржПржмржВ ржбрж┐ржлрж▓рзНржЯ ржЖржЪрж░ржг ржирж┐рж░рзНржзрж╛рж░ржг ржХрж░рзЗред

   * `PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION` тАФ ржпржжрж┐ DB error рж╣рзЯ, рждрж╛рж╣рж▓рзЗ Exception ржжрж┐ржмрзЗ; ржПрждрзЗ try/catch ржХрж░рж╛ ржпрж╛рзЯред
   * `PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC` тАФ `fetch()` ржХрж░рж▓рзЗ associative array (ржХрзА => ржорж╛ржи) ржкрж╛ржЗ; numeric index ржирзЯред
   * `PDO::ATTR_EMULATE_PREPARES => false` тАФ рж╕ржарж┐ржХ prepared statements ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ, SQL injection рж░рзЛржзрзЗ рж╕рж╣рж╛рзЯрждрж╛ ржХрж░рзЗред
5. `new PDO(...)` тАФ ржЖрж╕рж▓рзЗржЗ DB-рждрзЗ connect ржХрж░ржЫрзЗред
6. `catch (PDOException $e)` тАФ ржпржжрж┐ connection fail ржХрж░рзЗ, ржЖржорж░рж╛ HTTP 500 ржкрж╛ржарж┐рзЯрзЗ exit ржХрж░рзЗ ржжрж┐ржЪрзНржЫрж┐ред (development ржП message ржжрзЗржЦрж╛ржирзЛ ржпрж╛ржмрзЗ)

**ржХрзЗржи ржПржнрж╛ржмрзЗ?**

* Prepared statements + no emulation = safer against SQL injectionред
* Default fetch associative makes code readable (`$row['email']`)ред

---

# 4) `core/jwt.php` тАФ JWT encode / decode (functional, simple, safe)

```php
<?php
// core/jwt.php

function base64url_encode($data) {
  return rtrim(strtr(base64_encode($data), '+/', '-_'), '=');
}

function base64url_decode($data) {
  $remainder = strlen($data) % 4;
  if ($remainder) {
    $padlen = 4 - $remainder;
    $data .= str_repeat('=', $padlen);
  }
  return base64_decode(strtr($data, '-_', '+/'));
}

function jwt_encode(array $payload) {
  $cfg = include __DIR__ . '/../config/jwt.php';
  $header = ['alg' => $cfg['algo'], 'typ' => 'JWT'];

  $payloadEncoded = base64url_encode(json_encode($payload));
  $headerEncoded = base64url_encode(json_encode($header));

  $signature = hash_hmac('sha256', "$headerEncoded.$payloadEncoded", $cfg['secret'], true);
  $signatureEncoded = base64url_encode($signature);

  return "$headerEncoded.$payloadEncoded.$signatureEncoded";
}

function jwt_decode($token) {
  $cfg = include __DIR__ . '/../config/jwt.php';
  $parts = explode('.', $token);

  if (count($parts) !== 3) return false;

  list($headerEncoded, $payloadEncoded, $signatureEncoded) = $parts;

  $signature = base64url_decode($signatureEncoded);
  $expected = hash_hmac('sha256', "$headerEncoded.$payloadEncoded", $cfg['secret'], true);

  // timing-attack safe comparison
  if (!hash_equals($expected, $signature)) return false;

  $payloadJson = base64url_decode($payloadEncoded);
  $payload = json_decode($payloadJson, true);

  if (!$payload) return false;

  // check expiry if present
  if (isset($payload['exp']) && time() > $payload['exp']) return false;

  return $payload;
}
```

**ржмрзНржпрж╛ржЦрзНржпрж╛ (atomic):**

* `base64url_encode` / `base64url_decode` тАФ JWT-ржП ржмрзНржпржмрж╣рзГржд base64url ржлрж░ржорзНржпрж╛ржЯ; `+ /` ржХрзЗ `- _` ржжрж┐рзЯрзЗ replace ржХрж░рзЗ, ржУ trailing `=` ржорзБржЫрзЗ ржжрзЗрзЯред ржПржЯрж╛ URL-safeред
* `jwt_encode(array $payload)`:

  1. `include config/jwt.php` тАФ secret ржУ algo ржирзЗржмрзЗред
  2. `header` тАФ `{ "alg": "HS256", "typ": "JWT" }`ред
  3. `json_encode()` тЖТ `base64url_encode()` тАФ header ржУ payload encode ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред
  4. `hash_hmac('sha256', ...)` тАФ signature рждрзИрж░рж┐; рж╢рзЗрж╖ param `true` ржмрж▓рзЗ raw binary return ржХрж░рзЗ, ржпрзЗржЯрж╛ base64url encode ржХрж░рж╛ рж╣ржмрзЗред
  5. `return "$header.$payload.$signature"` тАФ JWT рж╕рзНржЯрзНрж░рж┐ржВред
* `jwt_decode($token)`:

  1. `explode('.', $token)` тАФ ржЯрзЛржХрзЗржиржХрзЗ рждрж┐ржи ржнрж╛ржЧрзЗ ржнрж╛ржЧ ржХрж░рзЗред
  2. signature verify тАФ рж╣рзНржпрж╛рж╢рж┐ржВ ржХрж░рзЗ `hash_equals()` ржжрж┐рзЯрзЗ рждрзБрж▓ржирж╛ (timing-attack safe)ред
  3. payload json decode ржХрж░рзЗ array ржкрж╛рзЯред
  4. `exp` ржпржжрж┐ ржерж╛ржХрзЗ ржПржмржВ ржПржХрзНрж╕ржкрж╛рзЯрж╛рж░ рж╣рзЯрзЗ ржерж╛ржХрзЗ тЖТ return falseред
  5. рж╕ржлрж▓ рж╣рж▓рзЗ payload array рж░рж┐ржЯрж╛рж░рзНржи ржХрж░ржмрзЗ (ржЙржжрж╛рж╣рж░ржг: `['sub'=>1,'email'=>'x@x.com','iat'=>...,'exp'=>...]`)

**ржХрзЗржи ржПржЗржнрж╛ржмрзЗ?**

* рж╕рж░рж▓ HS256 signature тАФ production ржП secret ржЕржмрж╢рзНржпржЗ рж╢ржХрзНрждрж┐рж╢рж╛рж▓рзА ржПржмржВ env ржП рж░рж╛ржЦржмрзЗред
* ржЖржорж░рж╛ `exp` ржЪрзЗржХ ржХрж░ржЫрж┐ ржпрж╛рждрзЗ token ржорзЗрзЯрж╛ржж рж╢рзЗрж╖ рж╣рж▓рзЗ refuse ржХрж░рж╛ рж╣рзЯред

---

# 5) `helpers/http.php` тАФ ржЫрзЛржЯ HTTP utilities

```php
<?php
// helpers/http.php

function get_json_input() {
  $raw = file_get_contents('php://input');
  $data = json_decode($raw, true);
  return is_array($data) ? $data : [];
}

function send_json($data, $status = 200) {
  http_response_code($status);
  header('Content-Type: application/json; charset=utf-8');
  echo json_encode($data, JSON_UNESCAPED_UNICODE);
  exit;
}

function get_bearer_token() {
  // getallheaders() is more portable, but on some setups you may use $_SERVER['HTTP_AUTHORIZATION']
  $headers = function_exists('getallheaders') ? getallheaders() : [];
  $auth = $headers['Authorization'] ?? $headers['authorization'] ?? ($_SERVER['HTTP_AUTHORIZATION'] ?? null);
  if (!$auth) return null;
  if (stripos($auth, 'Bearer ') === 0) {
    return trim(substr($auth, 7));
  }
  return null;
}

function respond_error($message = 'Error', $code = 400) {
  send_json(['error' => $message], $code);
}
```

**ржмрзНржпрж╛ржЦрзНржпрж╛ (atomic):**

* `file_get_contents('php://input')` тАФ HTTP request body рж░ ржЙржкрж╛ржжрж╛ржи ржирзЗржпрж╝ (raw)ред POST JSON ржкрж╛ржарж╛рж▓рзЗ ржПржЦрж╛ржи ржерзЗржХрзЗ JSON ржкрж╛ржмред
* `json_decode(..., true)` тАФ JSON тЖТ associative array; `true` ржжрж┐рж▓рзЗ array ржкрж╛ржпрж╝ред
* `send_json($data, $status)` тАФ standardized JSON response ржкрж╛ржарж╛рзЯ ржПржмржВ exit ржХрж░рзЗ ржпрж╛рждрзЗ code ржкрж░рзЗ ржЪрж▓рзЗ ржирж╛ред
* `get_bearer_token()` тАФ `Authorization: Bearer <token>` рж╣рзЗржбрж╛рж░ ржерзЗржХрзЗ token ржмрзЗрж░ ржХрж░рзЗ ржжрзЗрзЯред
* `respond_error()` тАФ error message ржкрж╛ржарж╛ржирзЛрж░ рж╕рж╣ржЬ wrapperред

---

# 6) `app/auth.php` тАФ Login handler (functional)

```php
<?php
// app/auth.php
require_once __DIR__ . '/../core/db.php';
require_once __DIR__ . '/../core/jwt.php';
require_once __DIR__ . '/../helpers/http.php';

function login_handler() {
  $data = get_json_input();

  $email = isset($data['email']) ? trim($data['email']) : '';
  $password = $data['password'] ?? '';

  if ($email === '' || $password === '') {
    respond_error('Email and password are required', 400);
  }

  $pdo = db_connect();

  // prepared statement ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрж┐: ржирж┐рж░рж╛ржкрждрзНрждрж╛рж░ ржЬржирзНржп
  $stmt = $pdo->prepare('SELECT id, email, password FROM users WHERE email = ? LIMIT 1');
  $stmt->execute([$email]);
  $user = $stmt->fetch(PDO::FETCH_ASSOC);

  if (!$user) {
    respond_error('Invalid credentials', 401);
  }

  // password_verify: hashed password ржорж┐рж▓рж╛ржирзЛ
  if (!password_verify($password, $user['password'])) {
    respond_error('Invalid credentials', 401);
  }

  // token payload - 'sub' subject рж╣рж┐рж╕рзЗржмрзЗ user id рж░рж╛ржЦрж╛ ржнрж╛рж▓рзЛ
  $cfg = include __DIR__ . '/../config/jwt.php';
  $now = time();
  $payload = [
    'sub' => (int)$user['id'],
    'email' => $user['email'],
    'iat' => $now,
    'exp' => $now + $cfg['expiry']
  ];

  $token = jwt_encode($payload);

  send_json(['token' => $token]);
}
```

**Atomic ржмрзНржпрж╛ржЦрзНржпрж╛ (ржкрзНрж░рждрзНржпрзЗржХ рж▓рж╛ржЗржи):**

1. `require_once ...` тАФ ржкрзНрж░рзЯрзЛржЬржирзАрзЯ ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ рж▓рзЛржб ржХрж░ржЫрж┐ (DB, JWT, HTTP helper)ред `require_once` ржпржжрж┐ ржлрж╛ржЗрж▓ ржирж╛ ржерж╛ржХрзЗ рждрж╛рж╣рж▓рзЗ fatal error ржжрж┐ржмрзЗ; ржПржХржмрж╛рж░ржЗ рж▓рзЛржб рж╣ржмрзЗред
2. `function login_handler()` тАФ login ржХрж░рж╛рж░ ржХрж╛ржЬ ржПржЦрж╛ржирзЗред ржпрзЗржХрзЛржи ржЬрж╛рзЯржЧрж╛ ржерзЗржХрзЗ `login_handler()` ржХрж▓ ржХрж░рж▓рзЗ ржХрж╛ржЬ рж╣ржмрзЗред
3. `$data = get_json_input();` тАФ request body ржерзЗржХрзЗ JSON read ржХрж░рзЗ array ржкрж╛ржЗред
4. `$email = isset($data['email']) ? trim($data['email']) : '';` тАФ ржЖржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзЗ, ржЖрж░ `trim()` ржХрж░рзЗ whitespace рж╕рж░рж╛ржЗред
5. `if ($email === '' || $password === '')` тАФ ржЗржиржкрзБржЯ validation; ржлрж╛ржБржХрж╛ рж╣рж▓рзЗ 400 Bad Requestред
6. `$pdo = db_connect();` тАФ PDO connection ржкрзЗрзЯрзЗ ржирж┐ржЪрзНржЫрж┐ред
7. `$stmt = $pdo->prepare('SELECT ...')` тАФ prepared statement рждрзИрж░рж┐ (ржкрзНрж░рждрж┐ ржнрзНржпрж╛рж░рж┐рзЯрзЗржмрж▓ ржЖрж▓рж╛ржжрж╛ ржХрж░рзЗ ржжрж┐рждрзЗ рж╣ржмрзЗ)ред
8. `$stmt->execute([$email]);` тАФ execute ржХрж░рж╛рж░ рж╕ржорзЯ array ржжрж┐рзЯрзЗ param bind ржХрж░рж╛ рж╣рж▓рзЛред ржПрждрзЗ SQL injection рж░рзЛржз рж╣рзЯред
9. `$user = $stmt->fetch(PDO::FETCH_ASSOC);` тАФ ржХрж╛рж▓рзЗ ржПржХ рж░рзЗржХрж░рзНржб ржкрзЗрж▓рж╛ржо (associative array)ред
10. `if (!$user)` тАФ ржЗржЙржЬрж╛рж░ ржирж╛ ржерж╛ржХрж▓рзЗ рж▓ржЧржЗржи ржирж╛ ржжрзЗрзЯрж╛ред
11. `password_verify($password, $user['password'])` тАФ plain password (user input) ржХрзЗ DB рждрзЗ рж░рж╛ржЦрж╛ hashed password рж╕ржЩрзНржЧрзЗ ржорж┐рж▓рж╛рзЯ; ржПржЯрж╛ ржирж┐рж░рж╛ржкржжред
12. `$cfg = include ...` тАФ JWT config ржирж┐рж▓рзЗ expiry ржУ secret ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмред
13. `iat` ржУ `exp` тАФ issued at ржПржмржВ expiry timestamp рж░рж╛ржЦрж╛ (security best-practice)ред
14. `$token = jwt_encode($payload);` тАФ JWT рждрзИрж░рж┐ред
15. `send_json(['token' => $token]);` тАФ successful response ржкрж╛ржарж╛ржирзЛ (HTTP 200)ред

**ржирзЛржЯ:** `password_verify` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛рж░ ржЖржЧрзЗ DB-ржП password `password_hash()` ржжрж┐рзЯрзЗ hashed рж░рж╛ржЦржмрзЗред ржХржЦржирзЛржЗ plain text рж╕ржВрж░ржХрзНрж╖ржг ржХрж░ржмрзЗ ржирж╛ред

---

# 7) `routes/api.php` тАФ рж╕рж░рж▓ dispatcher

```php
<?php
// routes/api.php
require_once __DIR__ . '/../app/auth.php';
require_once __DIR__ . '/../helpers/http.php';

$uri = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);
$method = $_SERVER['REQUEST_METHOD'];

// normalize trailing slash: '/api/login' and '/api/login/' treated same
$uri = rtrim($uri, '/');

if ($uri === '/api/login' && $method === 'POST') {
  login_handler();
} else {
  respond_error('Route not found', 404);
}
```

**ржмрзНржпрж╛ржЦрзНржпрж╛**

* `parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH)` тАФ request path ржирж┐рждрзЗ ржмрзНржпржмрж╣рзГрждред
* `$_SERVER['REQUEST_METHOD']` тАФ GET / POST ржЗрждрзНржпрж╛ржжрж┐ред
* `rtrim($uri,'/')` тАФ рж╢рзЗрж╖рзЗ slash ржерж╛ржХрж▓рзЗржУ ржПржХржЗ рж░рзБржЯ ржмрж╛ржирж╛рзЯред
* ржпржжрж┐ `/api/login` POST рж╣рзЯ тЖТ `login_handler()` ржХрж▓ ржХрж░рзЛ, ржирзЯрждрзЛ 404 responseред

---

# 8) `index.php` тАФ ржПржирзНржЯрзНрж░рж┐ ржкржпрж╝рзЗржирзНржЯ

```php
<?php
// index.php
// рж╕ржм response JSON рж╣ржмрзЗ
header('Content-Type: application/json; charset=utf-8');

require_once __DIR__ . '/routes/api.php';
```

**ржмрзНржпрж╛ржЦрзНржпрж╛**

* `header('Content-Type: application/json')` тАФ ржмрзНрж░рж╛ржЙржЬрж╛рж░ / Postman ржХрзЗ ржмрж▓ржЫрзЗ response JSONред
* `require_once 'routes/api.php'` тАФ рж░рж╛ржЙржЯ ржЪрж╛рж▓рзБ ржХрж░рзЗ ржжрзЗрзЯ; routes ржЦрзБржБржЬрзЗ ржХрж░рзЗ handler-run ржХрж░рзЗред

---

# 9) DB ржЯрзЗржмрж┐рж▓ (MySQL) тАФ `users` table

```sql
CREATE TABLE users (
  id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  email VARCHAR(255) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**ржмрзНржпрж╛ржЦрзНржпрж╛**

* `id` тАФ primary keyред
* `email` тАФ unique constraint; ржПржХржЗ email ржЖржмрж╛рж░ ржкрж╛ржмрзЗ ржирж╛ред
* `password` тАФ hashed password (bcrypt via `password_hash()`), рждрж╛ржЗ VARCHAR(255) рж░рж╛ржЦрж╛ рж╣рзЯрзЗржЫрзЗред
* `created_at` тАФ ржХржмрзЗ user рждрзИрж░рж┐ рж╣рзЯрзЗржЫрзЗ, auto timestampред

---

# 10) `scripts/create_user.php` тАФ ржкрзНрж░рж╛ржержорж┐ржХ User рждрзИрж░рж┐рж░ ржЬржирзНржп (CLI)

```php
<?php
// scripts/create_user.php
require_once __DIR__ . '/../core/db.php';

$email = $argv[1] ?? null;
$password = $argv[2] ?? null;

if (!$email || !$password) {
  echo "Usage: php create_user.php user@example.com password\n";
  exit(1);
}

$hash = password_hash($password, PASSWORD_DEFAULT);

$pdo = db_connect();
$stmt = $pdo->prepare('INSERT INTO users (email, password) VALUES (?, ?)');
try {
  $stmt->execute([$email, $hash]);
  echo "User created: $email\n";
} catch (PDOException $e) {
  echo "Error: " . $e->getMessage() . "\n";
}
```

**ржмрзНржпрж╛ржЦрзНржпрж╛**

* CLI script: `php scripts/create_user.php user@example.com strongpass`
* `password_hash()` тАФ plain password ржХрзЗ bcrypt (default) ржП hash ржХрж░рзЗ; DB-рждрзЗ ржПржЗ hashржЗ рж╕рзЗржн рж╣ржмрзЗред
* Prepared statement ржжрж┐рзЯрзЗ insert ржХрж░рж╛ рж╣рж▓рзЛред

---

# 11) Testing (Postman / curl)

**рзз) Create user (CLI)**

```
php scripts/create_user.php user@example.com 123456
```

(ржПржЯрж┐ DB рждрзЗ hashed password ржврзБржХрж╛ржмрзЗ)

**рзи) Login request (Postman / curl)**
URL: `http://localhost:8000/api/login`
Method: POST
Body тЖТ raw тЖТ JSON:

```json
{
  "email": "user@example.com",
  "password": "123456"
}
```

**curl ржХржорж╛ржирзНржб:**

```bash
curl -X POST http://localhost:8000/api/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"123456"}'
```

**Success response**

```json
{
  "token": "eyJhbGciOi..."
}
```

**Failure response (invalid credentials)**

```json
{
  "error": "Invalid credentials"
}
```

---

# 12) рж╕рж┐ржХрж┐ржЙрж░рж┐ржЯрж┐ ржирзЛржЯрж╕ (ржкрзНрж░рзЛржбрж╛ржХрж╢ржи-рж░рзЗржбрж┐ ржирзЯ ржХрж┐ржирзНрждрзБ ржнрж╛рж▓рзЛ рж╢рзБрж░рзБ)

* **Secret** `.env` ржерзЗржХрзЗ ржирзЗржмрзЗ; ржлрж╛ржЗрж▓ рж░рзЗржкрзЛржЬрж┐ржЯрж░рж┐рждрзЗ commit ржХрж░рзЛ ржирж╛ред
* HTTPS ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ тАФ token/credentials рж╕ржмрж╕ржорзЯ TLS-ржПрж░ ржЙржкрж░ ржкрж╛ржарж╛ржУред
* Token revoke ржмрж╛ blacklist ржжрж░ржХрж╛рж░ рж╣рж▓рзЗ DB/Redis ржП рж╕рзЗржЗ рж▓ржЬрж┐ржХ ржпрзЛржЧ ржХрж░рждрзЗ рж╣ржмрзЗред
* `expiry` ржЫрзЛржЯ рж░рж╛ржЦрзЛ (1 hour) ржПржмржВ refresh token pattern ржмрж┐ржмрзЗржЪржирж╛ ржХрж░рзЛред
* SQL errors ржХрзЗ ржЗржЙржЬрж╛рж░ржХрзЗ рж╕рж░рж╛рж╕рж░рж┐ ржжрзЗржЦрж┐ржУ ржирж╛ (ржЕржирзНрждржд production mode ржП)ред

---

# 13) ржЫрзЛржЯ-ржЦрж╛ржЯрзЛ ржкрзНрж░рж╢рзНржирзЗрж░ ржЙрждрзНрждрж░ (ржпрж╛ рждрзБржорж┐ рж╣рзЯржд ржнрж╛ржмржЫ)

* **ржХрзЗржи prepared statements?** тАФ SQL injection ржерзЗржХрзЗ ржмрж╛ржБржЪрж╛рждрзЗред `?` placeholder ржП ржнрзНржпрж╛рж▓рзБ ржЖрж▓рж╛ржжрж╛ ржкрж╛ржарж╛ржирзЛ рж╣рзЯ, SQL structure ржЖрж▓рж╛ржжрж╛ ржерж╛ржХрзЗред
* **ржХрзЗржи password_hash & password_verify?** тАФ plain password ржХржЦржирзЛ DB-ржП рж░рж╛ржЦржмрзЗ ржирж╛ред `password_hash()` bcrypt ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ hash ржжрзЗрзЯ; `password_verify()` ржжрж┐рзЯрзЗ ржорж┐рж▓рж╛ржирзЛ рж╣рзЯред
* **JWT ржХрж┐ржнрж╛ржмрзЗ verify рж╣рзЯ?** тАФ header.payload ржирж┐рзЯрзЗ secret ржжрж┐рзЯрзЗ HMAC ржХрж░рзЗ signature рждрзБрж▓ржирж╛ ржХрж░рж┐ред `hash_equals()` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ timing-attack-safe compare ржХрж░рж┐ред
* **ржХрзЗржи `base64url`?** тАФ JWT URL-safe base64 ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ (+ / тЖТ - _)ред

---

# 14) ржПржЦржи ржХрзА? (рждрзБржорж┐ ржХрзА ржЪрж╛ржУ ржЖржорж┐ ржкрж░рзЗрж░ ржзрж╛ржкрзЗржЗ ржЖржиржм)

* ржкрж░рзЗрж░ ржзрж╛ржкрзЗ ржЖржорж┐ ржПржХржЗ atomic style-ржП рждрзИрж░рж┐ ржХрж░ржм:

  1. `/api/products` (GET) тАФ рж╕ржХрж▓ ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржЖржирж╛ (PDO + prepared statement)
  2. `/api/products/{id}` (GET) тАФ ржПржХ ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржбрж┐ржЯрзЗржЗрж▓
  3. `/api/checkout` (POST) тАФ Bearer JWT token ржжрж┐рзЯрзЗ ржкрзНрж░ржЯрзЗржХрзНржЯ ржХрж░рж╛, ржПржмржВ basic checkout logic
* ржЪрж╛ржЗрж▓рзЗ ржЖржорж┐ ржПржЧрзБрж▓рзЛ ржПржХрзЗ ржПржХрзЗ ржжрж┐ржЗ, ржкрзНрж░рждрж┐ржЯрж╛ ржлрж╛ржЗрж▓рзЗрж░ ржкрзНрж░рждрж┐ржЯрж┐ рж▓рж╛ржЗржирзЗрж░ ржмрзНржпрж╛ржЦрзНржпрж╛ рж╕рж╣ред

---

ржнрж╛ржЗ, ржпржжрж┐ ржПржЦржирж┐ рж╢рзБрж░рзБ ржХрж░рждрзЗ ржЪрж╛ржУ тАФ ржмрж▓рзЛ, ржЖржорж┐ **Products API**тАУржПрж░ atomic ржЯрж┐ржЙржЯрзЛрж░рж┐рзЯрж╛рж▓ рж╢рзБрж░рзБ ржХрж░ржЫрж┐ (ржлрж╛ржВрж╢ржирж╛рж▓ рж╕рзНржЯрж╛ржЗрж▓)ред ржЕржержмрж╛ рждрзБржорж┐ ржЪрж╛ржЗрж▓рзЗ ржПржЗ Login ржХрзЛржб рждрзЛржорж╛рж░ рж▓рзЛржХрж╛рж▓ рж╕рж╛рж░рзНржнрж╛рж░рзЗ рж░рж╛ржи ржХрж░рзЛ тАФ ржХрзЛржи ржЬрж╛рзЯржЧрж╛рзЯ error ржжрзЗржЦрж▓рзЗ ржПржЦрж╛ржирзЗ paste ржХрж░рзЛ, ржЖржорж┐ step-by-step debug ржмрж▓ржмред
